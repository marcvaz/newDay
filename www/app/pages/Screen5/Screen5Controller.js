define(['require', 'app'], function(require, APP) {

    /**
     * Controller for Screen5 generated by Appery.io
     * @module Screen5
     */

    APP.controller('Screen5', ['$scope', 'Apperyio', controller]);

    function controller($scope, Apperyio) {

        /**
         * user controller variables
         */
        $scope.minutesRemaining = Apperyio.EntityAPI('Number');
        $scope.timerLength = Apperyio.EntityAPI('Number');
        $scope.timerStartTime = Apperyio.EntityAPI('Number');
        $scope.timerEndTime = Apperyio.EntityAPI('Number');
        $scope.secondsRemaining = Apperyio.EntityAPI('Number');
        $scope.taskDescriptionVar = Apperyio.EntityAPI('String');
        $scope.timerLengthSetting = Apperyio.EntityAPI('Number');

        /**
         * User controller functions
         */
        /**
         * @function init
         */
        $scope.init = function() {
            //On load screen logic
            $scope.subTasks = [];
            var $routeParams = Apperyio.get("$routeParams");
            $scope.taskDescriptionVar = $routeParams.a1;
            $scope.subTasks = $routeParams.a2.split(",");
            // length is just a pomodoro's duration
            $scope.timerLengthSetting = 25;
            $scope.minutesRemaining = 25;

        };

        /**
         * @function startTimer
         */
        $scope.startTimer = function() {
            var milliSecondsPerSecond = 1000;
            var secondsPerminute = 60;
            //UTC start time
            $scope.timerStartTime = new Date().getTime();
            //Expected UTC end time
            $scope.timerEndTime = $scope.timerStartTime + ($scope.timerLengthSetting * secondsPerminute * milliSecondsPerSecond);
            //console.log($scope.timerLength, secondsPerminute, milliSecondsPerSecond);
            // start the timer
            $scope.timerTickInterval = setInterval($scope.timerTick, milliSecondsPerSecond);
        };

        /**
         * @function timerTick
         */
        $scope.timerTick = function() {
            var milliSecondsPerSecond = 1000;
            var secondsPerminute = 60;
            var currentTime = new Date().getTime();
            var totalSecondsRemaining = (($scope.timerEndTime - currentTime) / milliSecondsPerSecond);
            //console.log(totalSecondsRemaining);
            $scope.minutesRemaining = Math.floor(totalSecondsRemaining / secondsPerminute);
            $scope.secondsRemaining = Math.floor(totalSecondsRemaining % secondsPerminute);
            //console.log($scope.minutesRemaining,$scope.secondsRemaining);
            if (totalSecondsRemaining < 1) {
                $scope.minutesRemaining = 0;
                $scope.secondsRemaining = 0;
                clearInterval($scope.timerTickInterval);
                if ("vibrate" in navigator) {
                    // vibration API supported
                    navigator.vibrate(10000);
                }
                alert("you've completed one work cycle");
                Apperyio.navigateTo("Screen8", {
                    a1: $scope.taskDescriptionVar
                });
            }
            // make the changes visible to the UI
            $scope.$apply();

        };

        /**
         * @function timerLengthChange
         */
        $scope.timerLengthChange = function() {
            //shut down the timer 
            if (typeof $scope.timerTickInterval !== undefined) {
                clearInterval($scope.timerTickInterval);
            }
            // initialize the time remaining
            $scope.minutesRemaining = $scope.timerLengthSetting;
            $scope.secondsRemaining = 0;
        };

    }

});