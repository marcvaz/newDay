define(['require', 'app'], function(require, APP) {

    /**
     * Controller for Screen6 generated by Appery.io
     * @module Screen6
     */

    APP.controller('Screen6', ['$scope', 'Apperyio', controller]);

    function controller($scope, Apperyio) {

        /**
         * user controller variables
         */
        $scope.minutesRemaining = Apperyio.EntityAPI('Number');
        $scope.secondsRemaining = Apperyio.EntityAPI('Number');
        $scope.timerStartTime = Apperyio.EntityAPI('Number');
        $scope.timerEndTime = Apperyio.EntityAPI('Number');
        $scope.breathingNotDone = Apperyio.EntityAPI('Boolean');
        $scope.taskDescriptionVar = Apperyio.EntityAPI('String');

        /**
         * User controller functions
         */
        /**
         * @function init
         */
        $scope.init = function() {
            //On load screen logic
            $scope.subTasks = [];
            var $routeParams = Apperyio.get("$routeParams");
            $scope.taskDescriptionVar = $routeParams.a1;
            var milliSecondsPerSecond = 1000;
            var secondsPerminute = 60;
            var timerLengthInMinutes = 1;
            $scope.breathingNotDone = true;
            //UTC start time
            $scope.timerStartTime = new Date().getTime();
            //Expected UTC end time
            $scope.timerEndTime = $scope.timerStartTime + (timerLengthInMinutes * secondsPerminute * milliSecondsPerSecond);
            //console.log($scope.timerLength, secondsPerminute, milliSecondsPerSecond);
            // start the timer
            $scope.timerTickInterval = setInterval($scope.timerTick, milliSecondsPerSecond);
        };

        /**
         * @function timerTick
         */
        $scope.timerTick = function() {
            var milliSecondsPerSecond = 1000;
            var secondsPerminute = 60;
            var currentTime = new Date().getTime();
            var totalSecondsRemaining = (($scope.timerEndTime - currentTime) / milliSecondsPerSecond);
            //console.log(totalSecondsRemaining);
            $scope.minutesRemaining = Math.floor(totalSecondsRemaining / secondsPerminute);
            $scope.secondsRemaining = Math.floor(totalSecondsRemaining % secondsPerminute);
            //console.log($scope.minutesRemaining,$scope.secondsRemaining);
            if (totalSecondsRemaining < 1) {
                $scope.breathingNotDone = false;
                $scope.minutesRemaining = 0;
                $scope.secondsRemaining = 0;
                clearInterval($scope.timerTickInterval);
                if ("vibrate" in navigator) {
                    // vibration API supported
                    navigator.vibrate(10000);
                }
            }
            // make the changes visible to the UI
            $scope.$apply();
        };

        /**
         * @function goToNextPage
         */
        $scope.goToNextPage = function() {
            Apperyio.navigateTo("Screen7", {
                a1: $scope.taskDescriptionVar
            });

        };

    }

});